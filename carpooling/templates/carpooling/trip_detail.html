{% extends "carpooling/main.html" %}
{% block head %}
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
    	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
{% endblock %}
{% block content %}
<div style="margin-bottom: 100px;">
<div id="map" style="width: 100%; height: 80vh"></div>
{% if matches %}
<div class="results" style="margin-bottom: 100px;">
	{% for match in matches %}
		<div>
			<h2> {{ match.destination }} </h2>
			<div style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 10px;">
				<div>From: {{ match.origin }} </div> 
				<div>Username: {{ match.username }} </div>
				<div>Match rate: {{ match.matchrate }}</div>
			</div>
		</div>
	{% endfor %}
</div>
{% endif %}
</div>
<script>
	let marker, dMarker
	let currenRroute, currentDest, current_location;
	const startLat = '{{ trip.origin_lat }}'
	const startLon = '{{ trip.origin_lon }}'
	const endLat = '{{ trip.destination_lat }}'
	const endLon = '{{ trip.destination_lon }}'
	console.log(startLat, startLon, endLat, endLon);

	// Initializes map
	const map = L.map('map', {
    		zoom: 16
	}); 

	// Sets initial coordinates and zoom level
	map.setView([51.505, -0.09], 16);

	// Sets map data source and associates with map
	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    		maxZoom: 19,
    		attribution: '© OpenStreetMap'
	}).addTo(map); 

	marker = L.marker([startLat, startLon]).addTo(map);

    	map.setView([startLat, startLon]);
	
	// Declare function to draw map
	function drawRoute(startLat, startLon, endLat, endLon) {
		fetch('http://router.project-osrm.org/route/v1/driving/' + startLon + ',' + startLat + ';' + endLon + ',' + endLat + '?geometries=geojson')
    		.then(function (response) {
        		return response.json();
    		})
    		.then(function (json) {
        		// Parse the response and create a LatLng array for the route
        		const route = json.routes[0];
        		const lineString = route.geometry;
        		let latLngs = [];
        		currentRoute = []
        		for (var i = 0; i < lineString.coordinates.length; i++) {
            			latLngs.push(L.latLng(lineString.coordinates[i][1], lineString.coordinates[i][0]));
        		}	
    				
    			// Add new markers and circle
    			dMarker = L.marker([endLat, endLon]).addTo(map);
        		// Add the route to the map
        		polyline = L.polyline(latLngs, {color: 'red'}).addTo(map);
    		})
    		.catch(error => {
    			console.log(error);
    		})
	}

    	drawRoute(startLat, startLon, endLat, endLon);
// L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
//    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org///licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
//    maxZoom: 18,
//    id: 'mapbox.streets',
//    accessToken: 'your_access_token_here'
//}).addTo(map);
	
	
</script>

{% endblock %}
